注：本文档侧重于从漏洞的角度进行渗透，社工和无线我会另说。







三大阶段，六小阶段







几个重要概念：
CVE（Common Vulnerabilitis and Exposures）：由美国的MITRE公司进行维护和管理，CVE的目的是提供一个标准化的命名体系，用于唯一标识和跟踪公开的安全漏洞和问题。
RCE（Remote Code Execute，远程代码执行）：这是一种著名的漏洞，比如经典的sql注入。
LPE（local Privilege Escalation，本地权限提升）：就是提权。







一 前期交互
1 对应于软件开发的问题定义、可行性分析、需求分析阶段。
2 在这个阶段，你要和客户充分交流以了解客户的需求。
3 一般来讲，渗透测试的目标是拿到某个系统的root。







二 情报搜集（信息打点，搜集、侦察、打点等叫法都一样）
（一）目的：获取目标的信息，以确定进攻思路。



（二）该工作对渗透测试工程师的要求：
1 情报收集的过程是隐秘的，不应让目标察觉到你的存在或分析出你的意图；
2 对情报收集的操作及结果进行条理清晰的记录，一个好的渗透测试工程师应该养成以严谨认真的态度记录操作及结果的好习惯，科学家通过条理清晰的记录可以复现实验，渗透师也应该能。



（三）情报的特点：
1 准确，这当然是最重要的事情；
2 全面：哪怕是一些看起来零零碎碎毫无价值的信息也要记录下来，没准后续会有用；
3 细致：如果不够细致，那么你可能会与可利用的系统漏洞或可实施攻击的目标失之交臂。







（四）搜集什么信息：
1 二进制：IP地址、端口情况，主要工具是ping、nmap。
2 web：资产、指纹，主要工具是各种网站、插件、工具。



（五）具体方法：
1 开源网站：详见hack.html。
2 插件。
3 工具：ping、nmap、layer、subfinder、httpx、ehole等。







三 漏洞挖掘（最重要的一步，决定了渗透测试的成败）
（一）漏洞是什么？（vulnerability）：软件（应用程序、操作系统）、网络协议、人中存在的缺陷或安全隐患。

三种漏洞：

1 软件漏洞（这是漏洞挖掘的主要目标）：
（1）软件漏洞在渗透测试中的作用：作为一个黑客，你想攻入某个园区网（企业网、政府网、校园网等），除去社工（攻击人）和无线（攻击公开网络）这两种方式，你只能通过这些网络的对外服务攻进去，而他们提高的服务往往以web服务为主，当黑客拿到对外服务主机后，将可以以此为跳板进攻内网。
（2）软件漏洞分类：系统及系统服务（一般统一认为是系统，这就是二进制安全，缓冲区溢出占到了50%）、web（web占到所有软件漏洞的70%）。

2 网络协议漏洞（网络作为基础设施其漏洞很难被修复，这也是为了中间人攻击、DDoS、无线破解在环境允许下总是可以成功，防守者只能尽量加大攻击者的攻击成本）：
无线渗透、DDoS、通信安全都是关于网络关于协议的攻击。

3 人：人是最大且最难被修复的漏洞。

4 漏洞的本质：
（1）权限是漏洞的土壤.
（2）如果没有权限，那么就不会有漏洞，正是因为有了权限，才有了漏洞。
（3）所有的漏洞攻击本质上都是在拿不该拿到的权限。

2 常见软件漏洞：
（1）注入类漏洞:
SQL注入
XML注入
LDAP注入
命令注入
代码注入等
（2）跨站类漏洞:
跨站脚本(XSS)
跨站请求伪造(CSRF)
（3）权限/身份验证类漏洞:
权限提升
暴力破解
凭证泄露
未授权访问等
（4）信息泄露类漏洞:
敏感信息泄露
目录遍历
信息枚举
源码泄露等
（5）配置类漏洞:
错误的安全配置
不安全的默认设置
（6）编程层面漏洞:
不安全的数据反序列化
逻辑错误漏洞
缓冲区溢出
整数溢出
竞争条件
3 漏洞危害的评价标准：漏洞存在的意义就在于拿到shell，因而，评价一个漏洞是否是高危漏洞的标准也是能不能拿到shell。








四 exploit（设计exp进行exploit）
（一）概念：
1 exploit这个单词就是渗透的意思，就是利用漏洞进行渗透的那一下（这一下可以是poc也可以是exp）。
2 我们一般叫漏洞利用（exp）或测试（poc），或漏洞攻击或测试、渗透攻击或测试。
3 exp和poc既指攻击程序也指那一下。



（二）攻击程序（exp） = 远控 + 后门
0 一些问题：有很多现成的rat和backdoor，不用我们真的去设计，比如meterpreter和msfvenom制出来的毒、emp3r0r和它生成的agent、蚁剑和一句话木马等。

思路：

1 三对渗透测试著名概念辨析：
（1）backdoor（后门）和rat（Remote Access Tool，远控工具）：指程序。
（2）target（受害主机）和cc（c2，command and control，c2服务器，攻击机）：指机器。
（3）被控端和控制端：既指程序也指机器，这是通俗叫法。

2 backdoor的别称（木马、病毒、payload、shellcode）：
（1）木马（Trojan Horse）：严格来看，中毒的正常文件才能被叫做木马，但是很多时候也把毒叫做木马，这个你注意一下就行别别人说什么不知道。
一种分类：分为大马和小马，小马负责通信（小马就是最基本的后门 == 网络 + 拿shell），大马就是APT的马。
（2）病毒（virus）：病毒其实更指那些具有传染性的后门程序，当然任何恶意程序都可以都叫做病毒。
（3）payload：汉语叫有效载荷，本义指协议包里的协议体即用户数据部分，在这里类比指实际用于攻击的代码。
其实不用去纠结到底谁是payload，后门就是payload。
（4）在二进制安全中，backdoor即大名鼎鼎的shellcode。
即使用-f raw得到的二进制代码。
是一段小型的、通常用汇编语言编写的代码。
名称由来：后门最基本的功能就是拿shell，这正是shellcode的名称由来，但是事实上shellcode能做的事多了。

3 后门的类型（深入理解后门）：在msf中我们分析了payload的类型：

=======
1 payload的一二级模块：
（1）一级：platform：linux、windows、android、mac、apple等。
（2）二级（有的没有）：arch：x64、x86_64（386）、mips等。

2 子模块（也不是每种paltform都有下面这些（比如android就没有bind，这是合理的，移动端几乎不可能暴露在公网上，因而bind是完全没必要的），但是总的来说有这些）：
（1）meterpreter和shell。
（2）内联（inline）和分阶段（stager）。
（3）reverse和bind。
（4）tcp还是http还是https或者tls。
=======

根据以上分析，可以看出，后门是分六种的，不同系统不同架构不同rat还分正向和反向，但是除了这四种，剩下的两种其实是小马也就是最基本后门的两个功能（网络 + 拿shell，以拿shell这个最基本的功能来代指所有的payload）的分类：
a 后门可分为inline和stager，这对应了后门对于核心payload的加载模式。
这里首先弄清楚一个概念：后门程序包括两个部分：一是加载器，二是payload（去拿shell的代码），加载器要去运行payload。
inline是文件马，即加载器和payload都被放到了target上，运行后加载器再加载payload。
stager是内存马，即先送上去一个stager（引导器），这个引导器只负责网络功能，然后再陆续接收payload，拿到payload后payload不落盘直接在内存里运行。
b 后门可分为tcp、http、https、tls等（甚至可以udp），这对应了后门的网络功能。
事实上可以看到：stager和回连协议已经在初步考虑免杀和流量伪装了。







五 后渗透的初级阶段（这是后渗透至少应该做的事，剩下的都是APT）
（零）后渗透概览：
1 后渗透（post exploitation，严格来说，没有第4阶段和第5阶段的区分，这里之所以这样区分是为了说明APT是高级别的后渗透）：

2 目标（作用）：对目标机进一步提权直到拿到目标机的root或以当前的目标机作为跳板进行内网渗透直到拿到目标网络中所有主机的权限，渗透的终极目标是拿到所有主机的root，并建立高级持续威胁。

3 APT（高级持续威胁）：使用APT工具进行高级持续威胁，所谓APT工具就是高级后门（（我认为一个最简单的后门就是拿到shell回连）），APT工具的主要技术有：
（1）防溯源：backdoor通过各种代理、CDN、TOR、SSwithKCP等回连RAT；
（2）流量伪装：HTTPS；
（3）进程隐藏rookit；
（4）适配各种系统版本；
（5）过杀软；
（6）信息收集，比如emp的ssh_harvester，用来收集ssh的明文密码；
（7）进一步渗透：比如emp的dockerscan和各种exploits建议；
（8）进程劫持：比如进程注入、gdb远程调试；
（9）痕迹清理：比如清除日志；
（10）持久化：crontab、类似于systemctl enable；
（11）提权；
（12）帮助其他后门：比如emp的bring2cc和代理链功能；
（13）阶段功能：这是避免突然大流量传输而导致引发管理员的注意或系统报警；
（14）集成bettercap等后渗透常见的工具；
（15）隧道端口转发；
（16）安装程序至被控端；
（17）允许用户开发个人模块并作为第三方模块集成到APT工具上。

4 总结上面我们可以得出：一个完整的后渗透应该包括哪些内容？
（1）最基本：拿shell回连；
（2）两个个基本点：防溯源（各种代理：SS、CDN、TOR等，顺便做了流量伪装了）、过杀软（适配、进程隐藏也属于这）。
（3）两个主要事：信息收集、进一步渗透（又分为提权横移和持久跳板）。
（4）无数附加功能：自定义第三方模块、端口转发、bettercap、进程注入等。
（5）痕迹清理。



（一）进一步渗透
1 提权
2 横移
3 持久化
4 跳板



（二）信息收集：内网信息收集。







六 APT（主要记录自己用过的工具，工具的具体用法详见每个工具的文档）
emp：通过该软件认识APT或者说整个后渗透的整体框架。
bettercap：后渗透的一个核心工具（其实主要就是arpspoof，在计算机网络原理里我们探讨过）。

