零 tor协议是一个经典的防溯源协议（还有I2P），主要功能是防溯源（匿名工具）和自由上网（无心插柳柳成荫）。







一 tor的正向代理
（零）在通信之前：tor代理客户端只要安装了就会自动去目录服务器下载tor网络（我们称网络中的节点为relay节点，tor网络由relay节点组成，relay节点 == 路由器）的节点列表和各节点的公钥。



（一）第一步：tor代理客户端随机选择了三个relay节点（guard节点（就是经常说的网桥）、middle节点、exit节点）。



（二）第二步：tor代理客户端先建立和guard节点之间的链路，然后由guard去找middle，middle去找exit，然后链路就建立了。



（三）第三步：通信时首先对数据进行三层加密（猜测数据的内容除了payload以外肯定还有目的地址信息），然后走三个节点，每个节点解密一层，最后由exit节点解密，然后发给目标服务器。



（四）注意：如果目标服务器是非暗网节点，则响应反着走三个节点就行，如果是暗网服务，那么这里就存在问题：暗网服务也是要实现匿名性的，那么代理客户端如何找到一个tor站点（.onion）呢？（后面我们会在tor工作过程中讲到）



（五）通过以上表述，我们可以看出tor匿名网络结构的三个关键组成：
1 目录服务器（存储tor网络的节点列表及公钥等信息）。

2 tor代理客户端（负责下载节点信息、随机选择节点、和网桥建立路径、给用户数据加密三层）。

3 relay节点：
（1）功能：负责解密和转发。
（2）类型：guard（网桥很多都在欧美地区且是稳定的大带宽主机）、middle、exit（出口节点是根据协议转发的，比如某个出口节点只负责HTTP的转发）。
（3）这里涉及一个道理：至少三个节点是可以防溯源的。







二 tor的用户值得信任吗？
（一）问题背景：tor发展起初，当tor客户端启动时，它需要获取所有可用的节点列表及相关信息，这个包含所有guard中继器的列表并不是一个秘密，虽然公开tor网络节点列表是必要的，但这也成为了一个问题。



（二）该问题的威胁性：
1 让我们来扮演攻击者的角色，问自己：一个Oppressive Government(OG)会怎么做？通过思考真正的OG会做什么，我们就能明白为什么tor会以这种方式构建。

2 真正的OD会怎么做？因为审查制度是一件相当麻烦的事情，而tor最擅长的就是绕过它，所以OG通常会阻止用户使用tor。

3 有两种方法可以阻止tor的使用：
（1）阻止用户从tor中出来：
对于非.onion站点而言，这是可能发生的，站点所有者需要下载tor的exit节点的列表，并阻塞这些节点的所有流量。
但是这个事情不要紧，因为很多站点并不愿意这么做（除非OG强迫），比如在Facebook的用户中使用tor甚至非常流行。
（2）阻止用户进入tor：
这是一种非常糟糕的情况，上面说了，guard节点列表是可以被下载的，那么，OG完全可以在GFW检查并禁止用户访问这些节点（尤其是这些节点还几乎都在欧美）。
为了应对这一情况，tor协议维护了一个总不公开的guard列表并且只下行给客户端一小部分guard节点列表。







三 tor的反向代理
（一）tor站点会开启一个tor代理客户端主动连接tor网络上的某个中继节点（称为接入点），要注意tor站点和接入点之间也是走了三层加密才通的。



（二）tor站点会将接入点信息、自己的公钥（二者构成一个描述符）并生成一个十六位的字符串（这个字符串就是.onion域名）发给目录服务器（所以目录服务器算是充当了tor网络的DNS服务器）。



（三）tor代理客户端要访问一个.onion时，会先做两件事：向目录服务器请求获得该站点的描述符（拿到接入点信息）和“随机选择节点、和网桥建立路径、给用户数据加密三层”（其中出口节点就是临时会话点）。这两件事做好后，代理客户端就向描述符中提供的接入点信息发送会话密钥和临时会话点信息，接入点把这个信息告诉tor站点，tor站点终于知道自己的反向代理服务器是谁了，于是向临时会话点发起三层加密连接，连接成功建立后，临时会话点通知代理客户端，然后就可以愉快的通信了。







四 如何配置并使用tor代理客户端？
（一）在Windows上你可以下载安装一个tor浏览器然后使用tor浏览器访问任意网站。



（二）在Linux上的配置和ss-local差不多，
第一步：你需要下载并安装tor代理客户端程序。

第二步：安装好了后你得修改/etc/tor/torrc文件：SocksPort 9050

第三步：sudo systemctl restart tor

第四步：配置proxychains配置文件或者使用torsocks工具，然后就可以使用了。（Linux默认会配置127.0.0.1:9050，Linux简直就是为暗网而生）







五 如何配置一个暗网站点？
第一步：下载安装tor（建议手动安装而非使用universe，在配置emp的tor防溯源中，我发现在某些系统上的apt install下来tor代理客户端不能使用，而且tor官方也不建议使用universe的tor，手动安装的教程详见https://support.torproject.org/apt/tor-deb-repo/）
sudo apt update
sudo apt install tor（既包括代理客户端也包括代理服务器）




第二步：安装好了后你得修改/etc/tor/torrc文件：
HiddenServiceDir /var/lib/tor/my_website/   # /var/lib/tor/my_website/是存储你的暗网站点信息用的，里面有一个文件叫hostname存储了.onion域名
HiddenServicePort 80 127.0.0.1:80   # 第一个80是tor的对外接口，第二个80的“127.0.0.1:80”是tor反向代理服务器的upstream服务。



第三步：sudo systemctl restart tor



第四步：拿.onion去tor浏览器试一下，看看能不能通。
