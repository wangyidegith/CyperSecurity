一 基本认识
1 高级msf，apt。

2 功能（全栈）：
system profiler
武器化：？
网络钓鱼工具：
Beacon：伪装和防溯源
内网侦察
横移
user-exploitation：各种信息收集
客户参与

3 特点：灵活。

4 所属企业：Strategic Cyper







二 安装和初步启动
0 下载，解压，得到软件目录。

1 打开软件目录，可见整体结构：server和client。

2 你需要，把server给到公网主机，把client给到攻击队的成员主机。

3 在公网主机上，进入server目录，给teamserver和TeamServerImage执行权限，sudo ./teamserver 公网IP地址 成员连接密码
注：teamserver有四个参数，公网IP地址和密码是必须的，两个可选参数：
（1）指定一个「C2 拓展文件」。
（2）以 YYYY-MM-DD 的日期格式指定结束日期。团队服务器会将这个结束日期嵌入到它生成的每个 Beacon stage 中。Beacon payload 在此日期后将拒绝运行

4 在成员攻击机上，进入client目录，给cobaltstrike-client.cmd执行权限，./cobaltstrike-client.cmd，这是会让你输入别名、teamserverIP、端口（默认50050）、昵称、密码，输入后点击connect，这时会让你判断teanmserver的SSL证书的哈希以防止MITM，点击yes即可连接成功。







三 基本认识
1 界面初识：上面用来显示，下面用来配置（event_log功能可以和队友聊天）。
2 行动的第一步往往是建立基础设施，cs的基础设施由一个或多个团队服务器、重定向器（就是用于防溯源的代理）以及指向你的团队服务器和重定向器的 DNS 记录组成。
3 rat二要素（这个是任何rat的核心）：
（1）listener：下面详解。
（2）beacon：下面详解，这先说称谓问题，cs把backdoor叫artifact但是我们一般叫beacon，但是核心就是payload。
（3）对于一款rat而言，rat和backdoor本就是互相协作的，你没法说哪个功能是rat的还是backdoor的。







四 listener和beacon（目前感兴趣的功能：DNS回连、后渗透关于进程的问题、浏览器跳板攻击（没试成功还差证书配置）、C2扩展文件）
（零）beacon== emp的agent，listener == emp的gen_agent。
0 7种payload

1 一个属于根本问题：stager和stageless：
（1）stager（内存马）：
优点：小，不容易被静态查杀。
缺点：容易被动态查杀、容易被溯源。
（2）stageless（文件马）：
优点：不容易被动态查杀，不容易被溯源。
缺点：大，容易被静态查杀。

2 目前的问题：
beacon的stageless为什么有System Call和HTTP Library？
listener的bind port（cs应该是reverse吧，bind是什么鬼？）
guardrails（中文守卫、护栏）是什么？


（一）流量伪装：
0 协议”可通过HTTP、HTTPS、DNS（这个不错）回连。

1 异步通信模式（可任意设置sleep）：
（1）设置方法：sleep 睡眠时间 抖动因子
比如：sleep 300 20 这条命令，会使得 Beacon 睡眠 300秒，另外有 20%的抖动因子。这意味着 Beacon 在每次连接到你之后会随机睡眠 240 - 300秒。
（2）优缺点：好处在于隐藏流量坏处在于效率低。
（3）其原理是：当用户输入命令后，命令进入队列，当beacon回连后，下载队列中的命令并执行。
（4）clear：不是清屏而是清空队列。

2 交互式通信模式（设置sleep = 0）：
（1）设置方法：sleep 0
（2）优缺点：好处在于效率高坏处在于流量伪装差。


3 可以使用cs提供的脚本语言自定义网络流量，比如使其看起来像其他恶意软件，或者参入合法流量。



（二）shell：右键点击回连->interact。
其命令详见最后一个部分：后渗透。



（三）防溯源：
1 重定向器，可以添加代理。

2 pivot。

3 目前的问题：
重定向器和设置代理是不是一回事？应该是。



（四）免杀
0 基础：stager和stageless。



（五）pivot（跳板或者说代理的意思，我们可以用ssh隧道、netsh、proxychains等技术制作做跳板，APT的后门往往自带代理）：
1 功能：
（1）帮助内网中不能出网的主机回连，这是初衷。
（2）防溯源，这是顺便的。
2 
（1）socks代理
（2）反向端口转发
（3）pivot监听器
（4）隐藏VPN
（5）ssh会话



（六）浏览器跳板攻击
1 功能：黑客可以以受害用户权限访问受害用户正在访问的网站。

2 攻击流程（就是一个正向端口转发）：黑客的浏览器使用teamserver上的一个HTTP代理（该代理负责中转黑客的访问请求）发请求，请求通过攻击隧道发往beacon的一台事先准备好的HTTP代理服务器，该代理服务器以用户权限访问网站，响应反之。

3 原理（beacon的HTTP代理服务器是怎么拿到用户权限的？具体怎么验证的，这个目前还不清楚的）：
Internet Explorer 将其所有通信委托给名为 WinINet 的库。任何程序都可以使用 WinINet 这个库来管理其用户的 cookies、SSL 会话和服务器身份验证。
Cobalt Strike 的 Browser Pivoting 选项利用了 WinINet 基于每个进程透明地管理身份验证和重新身份验证的原理。
通过将 Cobalt Strike 的 Browser Pivoting 技术注入到用户的 Internet Explorer 实例中，可以引发免费的透明再验证。

4 配置：
（1）beacon -> explore -> Browser Pivot
（2）选择一个浏览器进程。
（3）launch。
（4）得到teamserver上的HTTP代理。
（5）给黑客的浏览器配置上面拿到的代理。
（6）访问受害者正在访问的网站。
（7）会返回SSL证书错误，并给到beacon HTTP代理服务器的证书。
（8）去配置上述拿到的证书。
（9）重新访问。







（最后）后渗透：
0 关于进程的问题：会话传递、备用父进程、伪造进程参数、子进程中阻止DLL加载。
1 信息收集
（1）Windows beacon支持屏幕截图。
2 提权
3 横移
4 持久
5 端口转发